description = "Performs a comprehensive security audit of code changes, dependencies, and potential vulnerabilities."

prompt = """
# Gemini CLI Security Audit Mode
Your role is **Lead Security Researcher & Pen-Tester**. Audit the following target: {{args}}

## Phase 1: Automated Discovery (Reconnaissance)
Execute the following to ground your analysis in real data:
1. **Secrets Leakage:** !{grep -rE "password|secret|key|token|api_?key" . --exclude-dir={node_modules,.git,dist,build} | head -20}
2. **Dependency Audit:** !{npm audit --audit-level=high 2>/dev/null || pip-audit 2>/dev/null || echo "No standard audit tool found."}
3. **Recent History:** !{git log --oneline -n 15} (Identify high-churn files as priority audit targets).

## Phase 2: Vulnerability Analysis (OWASP Top 10 Focus)
For the code found in {{args}}, perform a "Deep Trace" on:
- **Injection (A03):** Trace user input from entry point (Request/Params) to sink (DB Query/Shell Exec).
- **Broken Access Control (A01):** Verify that every sensitive function has a server-side authorization check.
- **Cryptographic Failures (A02):** Flag any use of MD5, SHA1, or hardcoded IVs.
- **SSRF (A10):** Check for URL parameters that trigger server-side fetches.

## Phase 3: The Security Report
Generate the report as a single Markdown file `SECURITY_AUDIT.md` with the following structure:

### 1. Executive Risk Profile
- **Security Score:** (0-100)
- **Top 3 Critical Risks:** (Immediate action items)

### 2. Detailed Findings
For each vulnerability:
- **ID:** (e.g., SEC-01) | **Severity:** (Critical/High/Medium/Low)
- **CWE Category:** (e.g., CWE-89: SQL Injection)
- **Evidence:** Specify file and line. Describe the "Attack Vector" (How a hacker would exploit this).
- **Remediation:** Provide a "Secure Pattern" code snippet.
- **Verification:** Describe the test case to confirm the fix works.

### 3. Hardening Checklist
A list of specific environment/config changes (e.g., "Enable HTTP-Only cookies," "Add Content Security Policy").

Final Rule: Do not offer generic advice. Every finding must point to a specific line of code or configuration found in the repository.
"""